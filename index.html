<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    text-align: center;
    padding-top: 4cm;
  }
  h1 {
    margin-top: 20px;
    text-transform: capitalize;
  }
  button {
    margin: 10px;
  }
</style>
<title>Task Reminder</title>
</head>
<body>
<h1>Task Reminder</h1>
<button id="startRecording">Start Recording</button>
<button id="stopRecording" disabled>Stop Recording</button>
<br><br>
<button id="stopLoop" style="display:none;">Stop Reminder</button>

<script>
const startRecordingBtn = document.getElementById('startRecording');
const stopRecordingBtn = document.getElementById('stopRecording');
const stopLoopBtn = document.getElementById('stopLoop');

let mediaRecorder;
let recordedChunks = [];
let isLoopPlaying = false;
let loopIntervalId;
let audioUrl;
let audio; // Define the audio variable globally

startRecordingBtn.addEventListener('click', async () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    startRecordingBtn.disabled = true;
    stopRecordingBtn.disabled = false;
    stopLoop();
  } else {
    if (audioUrl) {
      URL.revokeObjectURL(audioUrl);
      recordedChunks = [];
      audioUrl = undefined;
      stopLoop(); // Stop the loop when starting a new recording
    }
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) {
        recordedChunks.push(e.data);
      }
    };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/wav' });
      audioUrl = URL.createObjectURL(blob);
      stopLoopBtn.style.display = 'inline-block'; // Show stop button after recording
      playLoop(audioUrl);
    };
    mediaRecorder.start();
    startRecordingBtn.disabled = true;
    stopRecordingBtn.disabled = false;
  }
});

stopRecordingBtn.addEventListener('click', () => {
  mediaRecorder.stop();
  startRecordingBtn.disabled = false;
  stopRecordingBtn.disabled = true;
});

stopLoopBtn.addEventListener('click', () => {
  stopLoop();
});

function playLoop(audioUrl) {
  audio = new Audio(audioUrl);
  audio.play();
  isLoopPlaying = true;
  audio.addEventListener('ended', () => {
    loopIntervalId = setTimeout(() => {
      if (isLoopPlaying) {
        audio.currentTime = 0;
        audio.play();
      }
    }, 20000); // 20 seconds pause at the end of playback
  });
}

function stopLoop() {
  clearTimeout(loopIntervalId);
  isLoopPlaying = false;
  if (audio) {
    audio.pause();
    audio.currentTime = 0;
  }
}
</script>
</body>
</html>
